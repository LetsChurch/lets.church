generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "interactiveTransactions"]
}

generator pothos {
  provider = "prisma-pothos-types"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [citext, uuidOssp(map: "uuid-ossp")]
}

enum AppUserRole {
  USER
  ADMIN

  @@map("app_user_role")
}

model AppUser {
  id                      String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                   String                   @unique @db.Citext
  username                String                   @unique @db.Citext
  password                String
  fullName                String?                  @db.VarChar(100)
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  deletedAt               DateTime?                @map("deleted_at")
  role                    AppUserRole              @default(USER)
  sessions                AppSession[]
  channelMemberships      ChannelMembership[]
  organizationMemberships OrganizationMembership[]
  uploads                 UploadRecord[]

  @@map("app_user")
}

model AppSession {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  appUserId String    @map("app_user_id") @db.Uuid
  appUser   AppUser   @relation(fields: [appUserId], references: [id])
  expiresAt DateTime  @default(dbgenerated("(now() + '14 days'::interval)")) @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("app_session")
}

model Organization {
  id           String                           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  slug         String                           @unique @db.Citext
  description  String?
  memberships  OrganizationMembership[]
  associations OrganizationChannelAssociation[]
  createdAt    DateTime                         @default(now()) @map("created_at")
  updatedAt    DateTime                         @updatedAt @map("updated_at")

  @@map("organization")
}

model OrganizationMembership {
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String       @map("channel_id") @db.Uuid
  appUser        AppUser      @relation(fields: [appUserId], references: [id])
  appUserId      String       @map("app_user_id") @db.Uuid
  isAdmin        Boolean      @default(false) @map("is_admin")
  canEdit        Boolean      @default(false) @map("can_edit")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  @@id([organizationId, appUserId])
  @@map("organization_membership")
}

model OrganizationChannelAssociation {
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String       @map("organization_id") @db.Uuid
  channel        Channel      @relation(fields: [channelId], references: [id])
  channelId      String       @map("channel_id") @db.Uuid
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  @@id([organizationId, channelId])
  @@map("organization_channel_association")
}

model Channel {
  id            String                           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  slug          String                           @unique
  description   String?
  memberships   ChannelMembership[]
  associations  OrganizationChannelAssociation[]
  createdAt     DateTime                         @default(now()) @map("created_at")
  updatedAt     DateTime                         @updatedAt @map("updated_at")
  uploadRecords UploadRecord[]

  @@map("channel")
}

model ChannelMembership {
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId String   @map("channel_id") @db.Uuid
  appUser   AppUser  @relation(fields: [appUserId], references: [id], onDelete: Cascade)
  appUserId String   @map("app_user_id") @db.Uuid
  isAdmin   Boolean  @default(false) @map("is_admin")
  canEdit   Boolean  @default(false) @map("can_edit")
  canUpload Boolean  @default(false) @map("can_upload")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@id([channelId, appUserId])
  @@map("channel_membership")
}

model UploadRecord {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  uploader            AppUser   @relation(fields: [appUserId], references: [id])
  appUserId           String    @map("app_user_id") @db.Uuid
  channel             Channel   @relation(fields: [channelId], references: [id])
  channelId           String    @map("channel_id") @db.Uuid
  uploadMimeType      String    @map("upload_mime_type")
  uploadSizeBytes     BigInt?   @map("upload_size_bytes")
  uploadFinalized     Boolean   @default(false) @map("upload_finalized")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  deletedAt           DateTime? @map("deleted_at")
  transcriptSentences Json?     @map("transcript_sentences") @db.Json

  @@map("upload_record")
}
